import 'package:enough_icalendar/enough_icalendar.dart';
import 'package:test/test.dart';

void main() {
  test('unwrap X-Apple-Structured-Location', () {
    const input =
        '''X-APPLE-STRUCTURED-LOCATION;VALUE=URI;X-APPLE-MAPKIT-HANDLE=CAES6gIIrk0Qx
 ofi3Z/fmujjARoSCVbY+FypC0lAEQAAAKi4zSxAIpgBCgdDemVjaGlhEgJDWhoGUHJhZ3VlK
 gZQcmFndWUyBlByYWd1ZToGMTE5IDAwQghQcmFndWUgMVIcbsOhbcSbc3TDrSBVIHN2YXTDq
 WhvIEppxZnDrVoEMzQvNGIhbsOhbcSbc3TDrSBVIHN2YXTDqWhvIEppxZnDrSAzNC80cg1Qc
 mFndWUgQ2FzdGxligEIUHJhZ3VlIDEqDlByYcW+c2vDvSBocmFkMg1QcmFndWUgQ2FzdGxlM
 iFuw6FtxJtzdMOtIFUgc3ZhdMOpaG8gSmnFmcOtIDM0LzQyDTExOSAwMCBQcmFndWUyB0N6Z
 WNoaWE4L1ABWk0KJQjGh+Ldn9+a6OMBEhIJVtj4XKkLSUARAAAAqLjNLEAYrk2QAwGiHyMIx
 ofi3Z/fmujjARoWCg5QcmHFvnNrw70gaHJhZBAAKgJlbg==;X-APPLE-RADIUS=141.29459
 06408928;X-TITLE="Pražský hrad\nPrague Castle, náměstí U svatého Jiří 34
 /4, 119 00 Prague, Czechia":geo:50.091106,14.401799''';
    final lines = VComponent.unfold(
      input.split('\n'),
      containsStandardCompliantLineBreaks: false,
    );
    expect(lines.length, 1);
    expect(lines.first, _expectedUnfoldedLines[6]);
  });

  test('unwrap Apple Location', () {
    const input = [
      'LOCATION:Pražský hrad\nPrague Castle, náměstí U svatého Jiří 34/4, 119 00 Prague, Czechia'
    ];
    final lines = VComponent.unfold(
      input,
      containsStandardCompliantLineBreaks: true,
    );
    expect(lines, isNotEmpty);
    expect(lines.first, input.first);
  });

  test('Unwrap Apple iCalendar (unix style line ending)', () {
    final lines = VComponent.unfold(
      _iCalendarTestData.split('\r\n'),
      containsStandardCompliantLineBreaks: true,
    );
    expect(lines[0], _expectedUnfoldedLines[0]);
    expect(lines[1], _expectedUnfoldedLines[1]);
    expect(lines[2], _expectedUnfoldedLines[2]);
    expect(lines[5], _expectedUnfoldedLines[5]);
    expect(lines[6], _expectedUnfoldedLines[6]);
    expect(lines[9], _expectedUnfoldedLines[9]);
    expect(lines, _expectedUnfoldedLines);
  });
  test('Parse apple VCalendar', () {
    final iCalendar = VComponent.parse(_iCalendarTestData);
    expect(iCalendar, isA<VCalendar>());
    expect((iCalendar as VCalendar).calendarName, 'Test1');
    expect(iCalendar.event, isNotNull);
    final event = iCalendar.event!;
    expect(event.start, DateTime(2022, 09, 29, 19, 30, 00));
    expect(
        event['DTEND']?[ParameterType.timezoneId]?.textValue, 'Europe/Prague');
    expect(event.location,
        'Pražský hrad\nPrague Castle, náměstí U svatého Jiří 34/4, 119 00 Prague, Czechia');
  });
}

const _iCalendarTestData = '''BEGIN:VCALENDAR\r
VERSION:2.0\r
X-WR-CALNAME:Test1\r
X-APPLE-CALENDAR-COLOR:#0E61B9FF\r
BEGIN:VEVENT\r
DTEND;TZID=Europe/Prague:20220929T203000\r
X-APPLE-STRUCTURED-LOCATION;VALUE=URI;X-APPLE-MAPKIT-HANDLE=CAES6gIIrk0Qx\r
 ofi3Z/fmujjARoSCVbY+FypC0lAEQAAAKi4zSxAIpgBCgdDemVjaGlhEgJDWhoGUHJhZ3VlK\r
 gZQcmFndWUyBlByYWd1ZToGMTE5IDAwQghQcmFndWUgMVIcbsOhbcSbc3TDrSBVIHN2YXTDq\r
 WhvIEppxZnDrVoEMzQvNGIhbsOhbcSbc3TDrSBVIHN2YXTDqWhvIEppxZnDrSAzNC80cg1Qc\r
 mFndWUgQ2FzdGxligEIUHJhZ3VlIDEqDlByYcW+c2vDvSBocmFkMg1QcmFndWUgQ2FzdGxlM\r
 iFuw6FtxJtzdMOtIFUgc3ZhdMOpaG8gSmnFmcOtIDM0LzQyDTExOSAwMCBQcmFndWUyB0N6Z\r
 WNoaWE4L1ABWk0KJQjGh+Ldn9+a6OMBEhIJVtj4XKkLSUARAAAAqLjNLEAYrk2QAwGiHyMIx\r
 ofi3Z/fmujjARoWCg5QcmHFvnNrw70gaHJhZBAAKgJlbg==;X-APPLE-RADIUS=141.29459\r
 06408928;X-TITLE="Pražský hrad\nPrague Castle, náměstí U svatého Jiří 34\r
 /4, 119 00 Prague, Czechia":geo:50.091106,14.401799\r
UID:3D2BE59F-AA5C-47C7-AB54-E795D97A69FF\r
DTSTAMP:20220927T091115Z\r
LOCATION:Pražský hrad\nPrague Castle\, náměstí U svatého Jiří 34/4\, 119 \r
 00 Prague\, Czechia\r
SEQUENCE:1\r
SUMMARY:Test Event\r
LAST-MODIFIED:20220927T091110Z\r
CREATED:20220927T091056Z\r
DTSTART;TZID=Europe/Prague:20220929T193000\r
END:VEVENT\r
BEGIN:VTIMEZONE\r
TZID:Europe/Prague\r
X-LIC-LOCATION:Europe/Prague\r
BEGIN:STANDARD\r
DTSTART:18500101T000000\r
RDATE:18500101T000000\r
TZNAME:PMT\r
TZOFFSETFROM:+005744\r
TZOFFSETTO:+005744\r
END:STANDARD\r
BEGIN:STANDARD\r
DTSTART:18911001T000000\r
RDATE:18911001T000000\r
TZNAME:CEST\r
TZOFFSETFROM:+005744\r
TZOFFSETTO:+0100\r
END:STANDARD\r
BEGIN:DAYLIGHT\r
DTSTART:19160430T230000\r
RDATE:19160430T230000\r
RDATE:19400401T020000\r
RDATE:19430329T020000\r
RDATE:19460506T020000\r
RDATE:19490409T020000\r
TZNAME:CEST\r
TZOFFSETFROM:+0100\r
TZOFFSETTO:+0200\r
END:DAYLIGHT\r
BEGIN:STANDARD\r
DTSTART:19161001T010000\r
RDATE:19161001T010000\r
RDATE:19421102T030000\r
RDATE:19431004T030000\r
RDATE:19441002T030000\r
RDATE:19451001T030000\r
RDATE:19461006T030000\r
TZNAME:CET\r
TZOFFSETFROM:+0200\r
TZOFFSETTO:+0100\r
END:STANDARD\r
BEGIN:DAYLIGHT\r
DTSTART:19170416T020000\r
RRULE:FREQ=YEARLY;UNTIL=19180415T010000Z;BYMONTH=4;BYDAY=3MO\r
TZNAME:CEST\r
TZOFFSETFROM:+0100\r
TZOFFSETTO:+0200\r
END:DAYLIGHT\r
BEGIN:STANDARD\r
DTSTART:19170917T030000\r
RRULE:FREQ=YEARLY;UNTIL=19180916T010000Z;BYMONTH=9;BYDAY=3MO\r
TZNAME:CET\r
TZOFFSETFROM:+0200\r
TZOFFSETTO:+0100\r
END:STANDARD\r
BEGIN:DAYLIGHT\r
DTSTART:19440403T020000\r
RRULE:FREQ=YEARLY;UNTIL=19450402T010000Z;BYMONTH=4;BYDAY=1MO\r
TZNAME:CEST\r
TZOFFSETFROM:+0100\r
TZOFFSETTO:+0200\r
END:DAYLIGHT\r
BEGIN:DAYLIGHT\r
DTSTART:19450509T000000\r
RDATE:19450509T000000\r
TZNAME:CEST\r
TZOFFSETFROM:+0200\r
TZOFFSETTO:+0200\r
END:DAYLIGHT\r
BEGIN:DAYLIGHT\r
DTSTART:19461201T030000\r
RDATE:19461201T030000\r
TZNAME:GMT\r
TZOFFSETFROM:+0100\r
TZOFFSETTO:+0000\r
END:DAYLIGHT\r
BEGIN:STANDARD\r
DTSTART:19470223T020000\r
RDATE:19470223T020000\r
TZNAME:CET\r
TZOFFSETFROM:+0000\r
TZOFFSETTO:+0100\r
END:STANDARD\r
BEGIN:DAYLIGHT\r
DTSTART:19470420T020000\r
RRULE:FREQ=YEARLY;UNTIL=19480418T010000Z;BYMONTH=4;BYDAY=3SU\r
TZNAME:CEST\r
TZOFFSETFROM:+0100\r
TZOFFSETTO:+0200\r
END:DAYLIGHT\r
BEGIN:STANDARD\r
DTSTART:19471005T030000\r
RRULE:FREQ=YEARLY;UNTIL=19491002T010000Z;BYMONTH=10;BYDAY=1SU\r
TZNAME:CET\r
TZOFFSETFROM:+0200\r
TZOFFSETTO:+0100\r
END:STANDARD\r
BEGIN:STANDARD\r
DTSTART:19790101T000000\r
RDATE:19790101T000000\r
TZNAME:CET\r
TZOFFSETFROM:+0100\r
TZOFFSETTO:+0100\r
END:STANDARD\r
BEGIN:DAYLIGHT\r
DTSTART:19790401T020000\r
RRULE:FREQ=YEARLY;UNTIL=19800406T010000Z;BYMONTH=4;BYDAY=1SU\r
TZNAME:CEST\r
TZOFFSETFROM:+0100\r
TZOFFSETTO:+0200\r
END:DAYLIGHT\r
BEGIN:STANDARD\r
DTSTART:19790930T030000\r
RRULE:FREQ=YEARLY;UNTIL=19950924T010000Z;BYMONTH=9;BYDAY=-1SU\r
TZNAME:CET\r
TZOFFSETFROM:+0200\r
TZOFFSETTO:+0100\r
END:STANDARD\r
BEGIN:DAYLIGHT\r
DTSTART:19810329T020000\r
RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU\r
TZNAME:CEST\r
TZOFFSETFROM:+0100\r
TZOFFSETTO:+0200\r
END:DAYLIGHT\r
BEGIN:STANDARD\r
DTSTART:19961027T030000\r
RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU\r
TZNAME:CET\r
TZOFFSETFROM:+0200\r
TZOFFSETTO:+0100\r
END:STANDARD\r
END:VTIMEZONE\r
BEGIN:VTIMEZONE\r
TZID:GMT+0200\r
X-LIC-LOCATION:GMT+0200\r
BEGIN:STANDARD\r
DTSTART:18000101T020000\r
RDATE:18000101T020000\r
TZNAME:+02\r
TZOFFSETFROM:+0200\r
TZOFFSETTO:+0200\r
END:STANDARD\r
END:VTIMEZONE\r
BEGIN:VTIMEZONE\r
TZID:GMT+0100\r
X-LIC-LOCATION:GMT+0100\r
BEGIN:STANDARD\r
DTSTART:18000101T010000\r
RDATE:18000101T010000\r
TZNAME:+01\r
TZOFFSETFROM:+0100\r
TZOFFSETTO:+0100\r
END:STANDARD\r
END:VTIMEZONE\r
END:VCALENDAR\r
''';

const _expectedUnfoldedLines = [
  'BEGIN:VCALENDAR',
  'VERSION:2.0',
  'X-WR-CALNAME:Test1',
  'X-APPLE-CALENDAR-COLOR:#0E61B9FF',
  'BEGIN:VEVENT',
  'DTEND;TZID=Europe/Prague:20220929T203000',
  'X-APPLE-STRUCTURED-LOCATION;VALUE=URI;X-APPLE-MAPKIT-HANDLE=CAES6gIIrk0Qxofi3Z/fmujjARoSCVbY+FypC0lAEQAAAKi4zSxAIpgBCgdDemVjaGlhEgJDWhoGUHJhZ3VlKgZQcmFndWUyBlByYWd1ZToGMTE5IDAwQghQcmFndWUgMVIcbsOhbcSbc3TDrSBVIHN2YXTDqWhvIEppxZnDrVoEMzQvNGIhbsOhbcSbc3TDrSBVIHN2YXTDqWhvIEppxZnDrSAzNC80cg1QcmFndWUgQ2FzdGxligEIUHJhZ3VlIDEqDlByYcW+c2vDvSBocmFkMg1QcmFndWUgQ2FzdGxlMiFuw6FtxJtzdMOtIFUgc3ZhdMOpaG8gSmnFmcOtIDM0LzQyDTExOSAwMCBQcmFndWUyB0N6ZWNoaWE4L1ABWk0KJQjGh+Ldn9+a6OMBEhIJVtj4XKkLSUARAAAAqLjNLEAYrk2QAwGiHyMIxofi3Z/fmujjARoWCg5QcmHFvnNrw70gaHJhZBAAKgJlbg==;X-APPLE-RADIUS=141.2945906408928;X-TITLE="Pražský hrad\nPrague Castle, náměstí U svatého Jiří 34/4, 119 00 Prague, Czechia":geo:50.091106,14.401799',
  'UID:3D2BE59F-AA5C-47C7-AB54-E795D97A69FF',
  'DTSTAMP:20220927T091115Z',
  'LOCATION:Pražský hrad\nPrague Castle\, náměstí U svatého Jiří 34/4\, 119 00 Prague\, Czechia',
  'SEQUENCE:1',
  'SUMMARY:Test Event',
  'LAST-MODIFIED:20220927T091110Z',
  'CREATED:20220927T091056Z',
  'DTSTART;TZID=Europe/Prague:20220929T193000',
  'END:VEVENT',
  'BEGIN:VTIMEZONE',
  'TZID:Europe/Prague',
  'X-LIC-LOCATION:Europe/Prague',
  'BEGIN:STANDARD',
  'DTSTART:18500101T000000',
  'RDATE:18500101T000000',
  'TZNAME:PMT',
  'TZOFFSETFROM:+005744',
  'TZOFFSETTO:+005744',
  'END:STANDARD',
  'BEGIN:STANDARD',
  'DTSTART:18911001T000000',
  'RDATE:18911001T000000',
  'TZNAME:CEST',
  'TZOFFSETFROM:+005744',
  'TZOFFSETTO:+0100',
  'END:STANDARD',
  'BEGIN:DAYLIGHT',
  'DTSTART:19160430T230000',
  'RDATE:19160430T230000',
  'RDATE:19400401T020000',
  'RDATE:19430329T020000',
  'RDATE:19460506T020000',
  'RDATE:19490409T020000',
  'TZNAME:CEST',
  'TZOFFSETFROM:+0100',
  'TZOFFSETTO:+0200',
  'END:DAYLIGHT',
  'BEGIN:STANDARD',
  'DTSTART:19161001T010000',
  'RDATE:19161001T010000',
  'RDATE:19421102T030000',
  'RDATE:19431004T030000',
  'RDATE:19441002T030000',
  'RDATE:19451001T030000',
  'RDATE:19461006T030000',
  'TZNAME:CET',
  'TZOFFSETFROM:+0200',
  'TZOFFSETTO:+0100',
  'END:STANDARD',
  'BEGIN:DAYLIGHT',
  'DTSTART:19170416T020000',
  'RRULE:FREQ=YEARLY;UNTIL=19180415T010000Z;BYMONTH=4;BYDAY=3MO',
  'TZNAME:CEST',
  'TZOFFSETFROM:+0100',
  'TZOFFSETTO:+0200',
  'END:DAYLIGHT',
  'BEGIN:STANDARD',
  'DTSTART:19170917T030000',
  'RRULE:FREQ=YEARLY;UNTIL=19180916T010000Z;BYMONTH=9;BYDAY=3MO',
  'TZNAME:CET',
  'TZOFFSETFROM:+0200',
  'TZOFFSETTO:+0100',
  'END:STANDARD',
  'BEGIN:DAYLIGHT',
  'DTSTART:19440403T020000',
  'RRULE:FREQ=YEARLY;UNTIL=19450402T010000Z;BYMONTH=4;BYDAY=1MO',
  'TZNAME:CEST',
  'TZOFFSETFROM:+0100',
  'TZOFFSETTO:+0200',
  'END:DAYLIGHT',
  'BEGIN:DAYLIGHT',
  'DTSTART:19450509T000000',
  'RDATE:19450509T000000',
  'TZNAME:CEST',
  'TZOFFSETFROM:+0200',
  'TZOFFSETTO:+0200',
  'END:DAYLIGHT',
  'BEGIN:DAYLIGHT',
  'DTSTART:19461201T030000',
  'RDATE:19461201T030000',
  'TZNAME:GMT',
  'TZOFFSETFROM:+0100',
  'TZOFFSETTO:+0000',
  'END:DAYLIGHT',
  'BEGIN:STANDARD',
  'DTSTART:19470223T020000',
  'RDATE:19470223T020000',
  'TZNAME:CET',
  'TZOFFSETFROM:+0000',
  'TZOFFSETTO:+0100',
  'END:STANDARD',
  'BEGIN:DAYLIGHT',
  'DTSTART:19470420T020000',
  'RRULE:FREQ=YEARLY;UNTIL=19480418T010000Z;BYMONTH=4;BYDAY=3SU',
  'TZNAME:CEST',
  'TZOFFSETFROM:+0100',
  'TZOFFSETTO:+0200',
  'END:DAYLIGHT',
  'BEGIN:STANDARD',
  'DTSTART:19471005T030000',
  'RRULE:FREQ=YEARLY;UNTIL=19491002T010000Z;BYMONTH=10;BYDAY=1SU',
  'TZNAME:CET',
  'TZOFFSETFROM:+0200',
  'TZOFFSETTO:+0100',
  'END:STANDARD',
  'BEGIN:STANDARD',
  'DTSTART:19790101T000000',
  'RDATE:19790101T000000',
  'TZNAME:CET',
  'TZOFFSETFROM:+0100',
  'TZOFFSETTO:+0100',
  'END:STANDARD',
  'BEGIN:DAYLIGHT',
  'DTSTART:19790401T020000',
  'RRULE:FREQ=YEARLY;UNTIL=19800406T010000Z;BYMONTH=4;BYDAY=1SU',
  'TZNAME:CEST',
  'TZOFFSETFROM:+0100',
  'TZOFFSETTO:+0200',
  'END:DAYLIGHT',
  'BEGIN:STANDARD',
  'DTSTART:19790930T030000',
  'RRULE:FREQ=YEARLY;UNTIL=19950924T010000Z;BYMONTH=9;BYDAY=-1SU',
  'TZNAME:CET',
  'TZOFFSETFROM:+0200',
  'TZOFFSETTO:+0100',
  'END:STANDARD',
  'BEGIN:DAYLIGHT',
  'DTSTART:19810329T020000',
  'RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU',
  'TZNAME:CEST',
  'TZOFFSETFROM:+0100',
  'TZOFFSETTO:+0200',
  'END:DAYLIGHT',
  'BEGIN:STANDARD',
  'DTSTART:19961027T030000',
  'RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU',
  'TZNAME:CET',
  'TZOFFSETFROM:+0200',
  'TZOFFSETTO:+0100',
  'END:STANDARD',
  'END:VTIMEZONE',
  'BEGIN:VTIMEZONE',
  'TZID:GMT+0200',
  'X-LIC-LOCATION:GMT+0200',
  'BEGIN:STANDARD',
  'DTSTART:18000101T020000',
  'RDATE:18000101T020000',
  'TZNAME:+02',
  'TZOFFSETFROM:+0200',
  'TZOFFSETTO:+0200',
  'END:STANDARD',
  'END:VTIMEZONE',
  'BEGIN:VTIMEZONE',
  'TZID:GMT+0100',
  'X-LIC-LOCATION:GMT+0100',
  'BEGIN:STANDARD',
  'DTSTART:18000101T010000',
  'RDATE:18000101T010000',
  'TZNAME:+01',
  'TZOFFSETFROM:+0100',
  'TZOFFSETTO:+0100',
  'END:STANDARD',
  'END:VTIMEZONE',
  'END:VCALENDAR',
];
